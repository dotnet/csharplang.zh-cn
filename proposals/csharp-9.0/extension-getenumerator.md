---
ms.openlocfilehash: a774e370a14373ccf308c2cba9944305c0053c05
ms.sourcegitcommit: c3df20406f43fcd460cfedd1cd61b6cc47d27250
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/08/2020
ms.locfileid: "89557559"
---
# <a name="extension-getenumerator-support-for-foreach-loops"></a><span data-ttu-id="f09a9-101">扩展 `GetEnumerator` 支持 `foreach` 循环。</span><span class="sxs-lookup"><span data-stu-id="f09a9-101">Extension `GetEnumerator` support for `foreach` loops.</span></span>

## <a name="summary"></a><span data-ttu-id="f09a9-102">总结</span><span class="sxs-lookup"><span data-stu-id="f09a9-102">Summary</span></span>
[summary]: #summary

<span data-ttu-id="f09a9-103">允许 foreach 循环识别扩展方法 GetEnumerator 方法，该方法以其他方式满足 foreach 模式，并在该表达式被视为错误时循环使用。</span><span class="sxs-lookup"><span data-stu-id="f09a9-103">Allow foreach loops to recognize an extension method GetEnumerator method that otherwise satisfies the foreach pattern, and loop over the expression when it would otherwise be an error.</span></span>

## <a name="motivation"></a><span data-ttu-id="f09a9-104">动机</span><span class="sxs-lookup"><span data-stu-id="f09a9-104">Motivation</span></span>
[motivation]: #motivation

<span data-ttu-id="f09a9-105">这会在实现 c # 中的其他功能（包括异步和基于模式的析构）的情况下引入 foreach 内联。</span><span class="sxs-lookup"><span data-stu-id="f09a9-105">This will bring foreach inline with how other features in C# are implemented, including async and pattern-based deconstruction.</span></span>

## <a name="detailed-design"></a><span data-ttu-id="f09a9-106">详细设计</span><span class="sxs-lookup"><span data-stu-id="f09a9-106">Detailed design</span></span>
[design]: #detailed-design

<span data-ttu-id="f09a9-107">Spec 更改相对简单。</span><span class="sxs-lookup"><span data-stu-id="f09a9-107">The spec change is relatively straightforward.</span></span> <span data-ttu-id="f09a9-108">修改 `The foreach statement` 此文本部分：</span><span class="sxs-lookup"><span data-stu-id="f09a9-108">We modify `The foreach statement` section to this text:</span></span>

><span data-ttu-id="f09a9-109">Foreach 语句的编译时处理首先确定表达式的 ***集合类型***、 ***枚举器类型*** 和 ***元素类型*** 。</span><span class="sxs-lookup"><span data-stu-id="f09a9-109">The compile-time processing of a foreach statement first determines the ***collection type***, ***enumerator type*** and ***element type*** of the expression.</span></span> <span data-ttu-id="f09a9-110">这种决定将按如下方式进行：</span><span class="sxs-lookup"><span data-stu-id="f09a9-110">This determination proceeds as follows:</span></span>
>
>*  <span data-ttu-id="f09a9-111">如果表达式的 `X` 类型*expression*是数组类型，则从到接口 (存在隐式引用转换， `X` `IEnumerable` 因为 `System.Array`) 实现此接口。</span><span class="sxs-lookup"><span data-stu-id="f09a9-111">If the type `X` of *expression* is an array type then there is an implicit reference conversion from `X` to the `IEnumerable` interface (since `System.Array` implements this interface).</span></span> <span data-ttu-id="f09a9-112">***集合类型***是 `IEnumerable` 接口，***枚举器类型***为 `IEnumerator` 接口，***元素类型***是数组类型的元素类型 `X` 。</span><span class="sxs-lookup"><span data-stu-id="f09a9-112">The ***collection type*** is the `IEnumerable` interface, the ***enumerator type*** is the `IEnumerator` interface and the ***element type*** is the element type of the array type `X`.</span></span>
>*  <span data-ttu-id="f09a9-113">如果表达式的 `X` 类型*expression*为，则 `dynamic` 从*expression*到 Interface 的隐式转换 `IEnumerable` ([隐式动态转换](conversions.md#implicit-dynamic-conversions)) 。</span><span class="sxs-lookup"><span data-stu-id="f09a9-113">If the type `X` of *expression* is `dynamic` then there is an implicit conversion from *expression* to the `IEnumerable` interface ([Implicit dynamic conversions](conversions.md#implicit-dynamic-conversions)).</span></span> <span data-ttu-id="f09a9-114">***集合类型***是 `IEnumerable` 接口，而***枚举器类型***是 `IEnumerator` 接口。</span><span class="sxs-lookup"><span data-stu-id="f09a9-114">The ***collection type*** is the `IEnumerable` interface and the ***enumerator type*** is the `IEnumerator` interface.</span></span> <span data-ttu-id="f09a9-115">如果 `var` 标识符指定为 *local_variable_type* 则该 ***元素类型*** 为 `dynamic` ，否则为 `object` 。</span><span class="sxs-lookup"><span data-stu-id="f09a9-115">If the `var` identifier is given as the *local_variable_type* then the ***element type*** is `dynamic`, otherwise it is `object`.</span></span>
>*  <span data-ttu-id="f09a9-116">否则，请确定该类型是否 `X` 具有适当的 `GetEnumerator` 方法：</span><span class="sxs-lookup"><span data-stu-id="f09a9-116">Otherwise, determine whether the type `X` has an appropriate `GetEnumerator` method:</span></span>
>    * <span data-ttu-id="f09a9-117">对 `X` 具有标识符 `GetEnumerator` 且无类型参数的类型执行成员查找。</span><span class="sxs-lookup"><span data-stu-id="f09a9-117">Perform member lookup on the type `X` with identifier `GetEnumerator` and no type arguments.</span></span> <span data-ttu-id="f09a9-118">如果成员查找不会生成匹配项，或者它产生了多义性，或者产生了不是方法组的匹配项，请检查可枚举的接口，如下所述。</span><span class="sxs-lookup"><span data-stu-id="f09a9-118">If the member lookup does not produce a match, or it produces an ambiguity, or produces a match that is not a method group, check for an enumerable interface as described below.</span></span> <span data-ttu-id="f09a9-119">如果成员查找产生了除方法组以外的任何内容，则建议发出警告。</span><span class="sxs-lookup"><span data-stu-id="f09a9-119">It is recommended that a warning be issued if member lookup produces anything except a method group or no match.</span></span>
>    * <span data-ttu-id="f09a9-120">使用生成的方法组和空参数列表执行重载决策。</span><span class="sxs-lookup"><span data-stu-id="f09a9-120">Perform overload resolution using the resulting method group and an empty argument list.</span></span> <span data-ttu-id="f09a9-121">如果重载决策导致没有适用的方法、导致歧义或产生单个最佳方法，但该方法是静态的或非公共的，请按如下所述检查可枚举的接口。</span><span class="sxs-lookup"><span data-stu-id="f09a9-121">If overload resolution results in no applicable methods, results in an ambiguity, or results in a single best method but that method is either static or not public, check for an enumerable interface as described below.</span></span> <span data-ttu-id="f09a9-122">如果重载决策产生了除明确的公共实例方法之外的任何内容，或者没有适用方法，则建议发出警告。</span><span class="sxs-lookup"><span data-stu-id="f09a9-122">It is recommended that a warning be issued if overload resolution produces anything except an unambiguous public instance method or no applicable methods.</span></span>
>    * <span data-ttu-id="f09a9-123">如果该方法的返回类型 `E` `GetEnumerator` 不是类、结构或接口类型，则会生成错误，并且不会执行任何其他步骤。</span><span class="sxs-lookup"><span data-stu-id="f09a9-123">If the return type `E` of the `GetEnumerator` method is not a class, struct or interface type, an error is produced and no further steps are taken.</span></span>
>    * <span data-ttu-id="f09a9-124">成员查找是在上 `E` 用标识符 `Current` 而不是类型参数执行的。</span><span class="sxs-lookup"><span data-stu-id="f09a9-124">Member lookup is performed on `E` with the identifier `Current` and no type arguments.</span></span> <span data-ttu-id="f09a9-125">如果成员查找没有生成任何匹配项，则结果为错误，或结果为除允许读取的公共实例属性之外的任何内容，并不执行任何其他步骤。</span><span class="sxs-lookup"><span data-stu-id="f09a9-125">If the member lookup produces no match, the result is an error, or the result is anything except a public instance property that permits reading, an error is produced and no further steps are taken.</span></span>
>    * <span data-ttu-id="f09a9-126">成员查找是在上 `E` 用标识符 `MoveNext` 而不是类型参数执行的。</span><span class="sxs-lookup"><span data-stu-id="f09a9-126">Member lookup is performed on `E` with the identifier `MoveNext` and no type arguments.</span></span> <span data-ttu-id="f09a9-127">如果成员查找没有生成任何匹配项，则结果为错误，或结果为除方法组外的任何内容，并不执行任何其他步骤。</span><span class="sxs-lookup"><span data-stu-id="f09a9-127">If the member lookup produces no match, the result is an error, or the result is anything except a method group, an error is produced and no further steps are taken.</span></span>
>    * <span data-ttu-id="f09a9-128">使用空参数列表对方法组执行重载决策。</span><span class="sxs-lookup"><span data-stu-id="f09a9-128">Overload resolution is performed on the method group with an empty argument list.</span></span> <span data-ttu-id="f09a9-129">如果重载决策导致没有适用的方法，导致不确定性，或者导致单个最佳方法，但该方法是静态的或非公共的，或者它的返回类型不是 `bool` ，则会生成错误，并且不会执行任何其他步骤。</span><span class="sxs-lookup"><span data-stu-id="f09a9-129">If overload resolution results in no applicable methods, results in an ambiguity, or results in a single best method but that method is either static or not public, or its return type is not `bool`, an error is produced and no further steps are taken.</span></span>
>    * <span data-ttu-id="f09a9-130">***集合类型***为 `X` ，***枚举器类型***为 `E` ，***元素类型***为属性的类型 `Current` 。</span><span class="sxs-lookup"><span data-stu-id="f09a9-130">The ***collection type*** is `X`, the ***enumerator type*** is `E`, and the ***element type*** is the type of the `Current` property.</span></span>
>
>*  <span data-ttu-id="f09a9-131">否则，请检查可枚举的接口：</span><span class="sxs-lookup"><span data-stu-id="f09a9-131">Otherwise, check for an enumerable interface:</span></span>
>    * <span data-ttu-id="f09a9-132">如果 `Ti` 存在从到的隐式转换到的所有类型 `X` `IEnumerable<Ti>` ，则有一个唯一类型， `T` 它 `T` 不是， `dynamic` 而对于所有其他类型的 `Ti` 都是从到的隐式转换 `IEnumerable<T>` ，而 `IEnumerable<Ti>` ***集合类型*** 是接口 `IEnumerable<T>` ， ***枚举器类型*** 为接口 `IEnumerator<T>` ， ***元素类型*** 为 `T` 。</span><span class="sxs-lookup"><span data-stu-id="f09a9-132">If among all the types `Ti` for which there is an implicit conversion from `X` to `IEnumerable<Ti>`, there is a unique type `T` such that `T` is not `dynamic` and for all the other `Ti` there is an implicit conversion from `IEnumerable<T>` to `IEnumerable<Ti>`, then the ***collection type*** is the interface `IEnumerable<T>`, the ***enumerator type*** is the interface `IEnumerator<T>`, and the ***element type*** is `T`.</span></span>
>    * <span data-ttu-id="f09a9-133">否则，如果有多个这样的类型 `T` ，则会生成错误，并且不会执行任何其他步骤。</span><span class="sxs-lookup"><span data-stu-id="f09a9-133">Otherwise, if there is more than one such type `T`, then an error is produced and no further steps are taken.</span></span>
>    * <span data-ttu-id="f09a9-134">否则，如果存在从到接口的隐式转换 `X` `System.Collections.IEnumerable` ，则 ***集合类型*** 为此接口， ***枚举器类型*** 为接口 `System.Collections.IEnumerator` ， ***元素类型*** 为 `object` 。</span><span class="sxs-lookup"><span data-stu-id="f09a9-134">Otherwise, if there is an implicit conversion from `X` to the `System.Collections.IEnumerable` interface, then the ***collection type*** is this interface, the ***enumerator type*** is the interface `System.Collections.IEnumerator`, and the ***element type*** is `object`.</span></span>
>*  <span data-ttu-id="f09a9-135">否则，确定类型 "X" 是否具有适当的 `GetEnumerator` 扩展方法：</span><span class="sxs-lookup"><span data-stu-id="f09a9-135">Otherwise, determine whether the type 'X' has an appropriate `GetEnumerator` extension method:</span></span>
>    * <span data-ttu-id="f09a9-136">对标识符为的类型执行扩展方法查找 `X` `GetEnumerator` 。</span><span class="sxs-lookup"><span data-stu-id="f09a9-136">Perform extension method lookup on the type `X` with identifier `GetEnumerator`.</span></span> <span data-ttu-id="f09a9-137">如果成员查找不会生成匹配项，或者它产生了多义性，或者产生了不是方法组的匹配项，则会生成错误，并且不会执行任何其他步骤。</span><span class="sxs-lookup"><span data-stu-id="f09a9-137">If the member lookup does not produce a match, or it produces an ambiguity, or produces a match which is not a method group, an error is produced and no further steps are taken.</span></span> <span data-ttu-id="f09a9-138">如果成员查找产生了除方法组外的任何内容，或者没有匹配项，则建议发出警告。</span><span class="sxs-lookup"><span data-stu-id="f09a9-138">It is recommended that a warning be issues if member lookup produces anything except a method group or no match.</span></span>
>    * <span data-ttu-id="f09a9-139">使用生成的方法组和一个类型的参数来执行重载决策 `X` 。</span><span class="sxs-lookup"><span data-stu-id="f09a9-139">Perform overload resolution using the resulting method group and a single argument of type `X`.</span></span> <span data-ttu-id="f09a9-140">如果重载决策不生成适用的方法、导致歧义，或者导致单个最佳方法，但该方法不可访问，则不会执行任何其他步骤。</span><span class="sxs-lookup"><span data-stu-id="f09a9-140">If overload resolution produces no applicable methods, results in an ambiguity, or results in a single best method but that method is not accessible, an error is produced an no further steps are taken.</span></span>
>        * <span data-ttu-id="f09a9-141">如果是一个结构类型，则此解决方法允许 ref 传递第一个参数 `X` ，而 ref 类型为 `in` 。</span><span class="sxs-lookup"><span data-stu-id="f09a9-141">This resolution permits the first argument to be passed by ref if `X` is a struct type, and the ref kind is `in`.</span></span>
>    * <span data-ttu-id="f09a9-142">如果该方法的返回类型 `E` `GetEnumerator` 不是类、结构或接口类型，则会生成错误，并且不会执行任何其他步骤。</span><span class="sxs-lookup"><span data-stu-id="f09a9-142">If the return type `E` of the `GetEnumerator` method is not a class, struct or interface type, an error is produced and no further steps are taken.</span></span>
>    * <span data-ttu-id="f09a9-143">成员查找是在上 `E` 用标识符 `Current` 而不是类型参数执行的。</span><span class="sxs-lookup"><span data-stu-id="f09a9-143">Member lookup is performed on `E` with the identifier `Current` and no type arguments.</span></span> <span data-ttu-id="f09a9-144">如果成员查找没有生成任何匹配项，则结果为错误，或结果为除允许读取的公共实例属性之外的任何内容，并不执行任何其他步骤。</span><span class="sxs-lookup"><span data-stu-id="f09a9-144">If the member lookup produces no match, the result is an error, or the result is anything except a public instance property that permits reading, an error is produced and no further steps are taken.</span></span>
>    * <span data-ttu-id="f09a9-145">成员查找是在上 `E` 用标识符 `MoveNext` 而不是类型参数执行的。</span><span class="sxs-lookup"><span data-stu-id="f09a9-145">Member lookup is performed on `E` with the identifier `MoveNext` and no type arguments.</span></span> <span data-ttu-id="f09a9-146">如果成员查找没有生成任何匹配项，则结果为错误，或结果为除方法组外的任何内容，并不执行任何其他步骤。</span><span class="sxs-lookup"><span data-stu-id="f09a9-146">If the member lookup produces no match, the result is an error, or the result is anything except a method group, an error is produced and no further steps are taken.</span></span>
>    * <span data-ttu-id="f09a9-147">使用空参数列表对方法组执行重载决策。</span><span class="sxs-lookup"><span data-stu-id="f09a9-147">Overload resolution is performed on the method group with an empty argument list.</span></span> <span data-ttu-id="f09a9-148">如果重载决策导致没有适用的方法，导致不确定性，或者导致单个最佳方法，但该方法是静态的或非公共的，或者它的返回类型不是 `bool` ，则会生成错误，并且不会执行任何其他步骤。</span><span class="sxs-lookup"><span data-stu-id="f09a9-148">If overload resolution results in no applicable methods, results in an ambiguity, or results in a single best method but that method is either static or not public, or its return type is not `bool`, an error is produced and no further steps are taken.</span></span>
>    * <span data-ttu-id="f09a9-149">***集合类型***为 `X` ，***枚举器类型***为 `E` ，***元素类型***为属性的类型 `Current` 。</span><span class="sxs-lookup"><span data-stu-id="f09a9-149">The ***collection type*** is `X`, the ***enumerator type*** is `E`, and the ***element type*** is the type of the `Current` property.</span></span>
>*  <span data-ttu-id="f09a9-150">否则，将生成错误，并且不执行任何其他步骤。</span><span class="sxs-lookup"><span data-stu-id="f09a9-150">Otherwise, an error is produced and no further steps are taken.</span></span>

<span data-ttu-id="f09a9-151">对于 `await foreach` ，规则的修改方式也类似。</span><span class="sxs-lookup"><span data-stu-id="f09a9-151">For `await foreach`, the rules are similarly modified.</span></span> <span data-ttu-id="f09a9-152">该规范所需的唯一更改是 `Extension methods do not contribute.` 从说明中删除该行，因为该规范的其余部分基于以上规则，这些规则的名称替换为模式方法的不同名称。</span><span class="sxs-lookup"><span data-stu-id="f09a9-152">The only change that is required to that spec is removing the `Extension methods do not contribute.` line from the description, as the rest of that spec is based on the above rules with different names substituted for the pattern methods.</span></span>

## <a name="drawbacks"></a><span data-ttu-id="f09a9-153">缺点</span><span class="sxs-lookup"><span data-stu-id="f09a9-153">Drawbacks</span></span>
[drawbacks]: #drawbacks

<span data-ttu-id="f09a9-154">每次更改都会增加语言的复杂性，并且这可能会使设计不是 ed 的东西 `foreach` `foreach` （如） `Range` 。</span><span class="sxs-lookup"><span data-stu-id="f09a9-154">Every change adds additional complexity to the language, and this potentially allows things that weren't designed to be `foreach`ed to be `foreach`ed, like `Range`.</span></span>

## <a name="alternatives"></a><span data-ttu-id="f09a9-155">备选方法</span><span class="sxs-lookup"><span data-stu-id="f09a9-155">Alternatives</span></span>
[alternatives]: #alternatives

<span data-ttu-id="f09a9-156">不执行任何操作。</span><span class="sxs-lookup"><span data-stu-id="f09a9-156">Doing nothing.</span></span>

## <a name="unresolved-questions"></a><span data-ttu-id="f09a9-157">未解决的问题</span><span class="sxs-lookup"><span data-stu-id="f09a9-157">Unresolved questions</span></span>
[unresolved]: #unresolved-questions

<span data-ttu-id="f09a9-158">目前无。</span><span class="sxs-lookup"><span data-stu-id="f09a9-158">None at this point.</span></span>
